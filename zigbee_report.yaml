alias: "ğŸ“Š Zigbee : Rapport Journalier"
description: Envoie un bilan des piles et devices offline chaque soir Ã  20h
triggers:
  - trigger: time
    at: "17:18:00"
conditions:
  - condition: numeric_state
    entity_id: sensor.zigbee_battery_alerts
    above: 0
actions:
  - variables:
      alert_list: >
        {% set devices = state_attr('sensor.zigbee_battery_alerts',
        'alert_devices') | default([]) %} {% set report = namespace(text="") %}
        {% for d in devices %}
          {% set info = "" %}
          {% if d.status == 'offline' %}
            {% set info = "ğŸ”´ **HORS-LIGNE**" %}
          {% elif d.battery == '?' %}
            {% set info = "â“ **BATTERIE INCONNUE**" %}
          {% else %}
            {% set info = "ğŸª« **BATTERIE " ~ d.battery ~ "%**" %}
          {% endif %}
          {% set report.text = report.text ~ "- " ~ d.name ~ " : " ~ info ~ " (DerniÃ¨re maintenance : *" ~ d.maintenance ~ "*)\n" %}
        {% endfor %} {{ report.text }}
  - action: script.k_2so_generateur_de_message
    data:
      mission: rapport_zigbee
      details: "{{ alert_list }}"
      consigne: >-
        Fais une courte introduction sarcastique (2-3 phrases) sur
        l'incompÃ©tence de l'humain Ã  gÃ©rer ses piles. Ne liste pas les appareils
        toi-mÃªme, je vais les ajouter aprÃ¨s.
    response_variable: generated_message
  - parallel:
      - action: script.notification_discord
        data:
          nom: ğŸ“Š Rapport SantÃ© Zigbee
          description: |
            {{ generated_message.data }}

            **Liste des appareils en souffrance :**
            {{ alert_list }}
      - action: script.awtrix_dynamique_customapp_and_notify
        data:
          message: "Zigbee: {{ states('sensor.zigbee_battery_alerts') }} alertes"
          icone: warning
          color: "#FFA500"
          rainbow: "false"
          scrollspeed: "50"
          duree: "25"
mode: single
