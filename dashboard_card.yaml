type: vertical-stack
cards:
  - type: markdown
    title: ğŸ”‹ Ã‰tat des Piles Zigbee
    icon: mdi:battery-check
    content: |
      {% set devices = state_attr('sensor.z2m_battery_devices', 'devices') %}
      {% set ns = namespace(alerts=[], ok=[]) %}
      {% for d in devices %}
        {% set bat_val = d.battery | float(-1) if d.battery != '?' else -1 %}
        {% if d.status == 'offline' or d.battery == '?' or (bat_val != -1 and bat_val < 15) %}
          {% set ns.alerts = ns.alerts + [{'name': d.name, 'bat_display': d.battery, 'bat_val': bat_val, 'status': d.status, 'maint': d.maintenance}] %}
        {% else %}
          {% set ns.ok = ns.ok + [{'name': d.name, 'bat_display': d.battery, 'bat_val': bat_val, 'status': d.status, 'maint': d.maintenance}] %}
        {% endif %}
      {% endfor %}

      {% if ns.alerts | length > 0 %}
      ### ğŸš¨ Ã€ VÃ©rifier ({{ ns.alerts | length }})
      | Appareil | ProblÃ¨me | Batterie | Date |
      | :--- | :--- | :---: | :--- |
      {% for d in ns.alerts | sort(attribute='bat_val') -%}
      | **{{ d.name }}** | {{ 'ğŸ”´ HORS-LIGNE' if d.status == 'offline' else 'âš ï¸ FAIBLE' if d.bat_val != -1 else 'â“ INCONNU' }} | {{ d.bat_display }}% | {{ d.maint }} |
      {% endfor %}
      {% endif %}

      ### âœ… OpÃ©rationnels ({{ ns.ok | length }})
      | Appareil | Batterie | Maintenance |
      | :--- | :---: | :--- |
      {% for d in ns.ok | sort(attribute='bat_val') -%}
      | {{ d.name }} | ğŸ”‹ {{ d.bat_display }}% | {{ d.maint }} |
      {% endfor %}
  
  - type: button
    entity: button.actualiser_monitoring_zigbee
    name: Forcer l'Actualisation
    icon: mdi:refresh
    show_name: true
    show_icon: true
    tap_action:
      action: call-service
      service: button.press
      target:
        entity_id: button.actualiser_monitoring_zigbee
